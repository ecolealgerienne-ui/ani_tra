1. OVERVIEW
Objectif
Permettre aux fermiers de consulter l'historique des pesÃ©es d'un animal (10 derniÃ¨res) avec dÃ©tection automatique d'une baisse de poids suspecte via un seuil configurable par ferme.
Principes

âœ… Light & Fast: 10 pesÃ©es max (mobile perf)
âœ… Offline: SQLite natif, zÃ©ro serveur
âœ… Configurable: Seuil alerte par ferme
âœ… VisibilitÃ©: Alertes dans 4 endroits clÃ©s
âŒ Pas de graphs/GMQ: RÃ©servÃ© Phase 2 serveur


2. DESIGN UI/UX
2.1 DetailScreen Animal (Modification)
Section Poids - AVANT:
ğŸ“Š POIDS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  23.0 kg | Le 15/11/2025
  [+]  [Ajouter pesÃ©e]
Section Poids - APRÃˆS:
ğŸ“Š POIDS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  23.0 kg | Le 15/11/2025
  [ğŸ“‹ Historique]
Action: Click â†’ WeightHistoryScreen

2.2 WeightHistoryScreen (Nouvel Ã©cran)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Historique des PesÃ©es          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚ ğŸ“Š BREBIS-042                    â”‚
â”‚                                  â”‚
â”‚ 23.0 kg  |  15/11/2025          â”‚
â”‚ 22.5 kg  |  13/11/2025          â”‚
â”‚ 21.8 kg  |  10/11/2025          â”‚
â”‚ 20.5 kg  |  08/11/2025          â”‚
â”‚ ...                              â”‚
â”‚ (max 10 entrÃ©es)                 â”‚
â”‚                                  â”‚
â”‚ [+ Ajouter une pesÃ©e]            â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Specs:

Liste triÃ©e DESC (plus rÃ©cent en haut)
Affichage: {weight} kg | {date}
Max 10 entrÃ©es (LIMIT 10 SQL)
Bouton [+] en bas pour ajouter rapidement
Titre: clÃ© i18n 'weightHistory' (existante)


3. ALERTE BAISSE POIDS
3.1 Configuration Ferme
Nouveau field dans FarmPreferences:
dartweightDropThresholdPercent: double  // ex: 10.0
```

**Interface Settings**:
```
âš™ï¸ ParamÃ¨tres Ferme
â”œâ”€ Seuil baisse poids: [10 %] â† input configurable
â”œâ”€ Type animal dÃ©faut: [Brebis]
â””â”€ Race dÃ©faut: [MÃ©rinos]
Valeur par dÃ©faut: 10.0% (constante globale)

3.2 Constantes & I18N
constants.dart (nouveau):
dartstatic const double DEFAULT_WEIGHT_DROP_THRESHOLD = 10.0; // %
app_strings.dart (ajouter):
dartstatic const String weightDropThreshold = 'weightDropThreshold';
static const String weightDropAlert = 'weightDropAlert';
static const String percentLoss = 'percentLoss';
strings_fr.dart (ajouter):
dart'weightDropThreshold': 'Seuil baisse poids (%)',
'weightDropAlert': 'âš ï¸ Baisse de poids',
'percentLoss': '{percent}% (de {before}kg Ã  {after}kg)',

3.3 Logique Alerte (Repository)
OÃ¹: WeightRepository.addWeight()
dartFuture<void> addWeight(WeightRecord weight, String farmId) async {
  // 1. RÃ©cupÃ©rer derniÃ¨re pesÃ©e
  final previous = await _dao.getPreviousByAnimal(
    weight.animalId, 
    farmId
  );
  
  // 2. VÃ©rifier baisse si existe
  if (previous != null) {
    final farmConfig = await _farmRepository.getConfig(farmId);
    final threshold = farmConfig.weightDropThresholdPercent ?? 
                     DEFAULT_WEIGHT_DROP_THRESHOLD;
    
    final percentDrop = ((previous.weight - weight.weight) / 
                        previous.weight) * 100;
    
    // 3. CrÃ©er alerte si dÃ©passÃ©
    if (percentDrop > threshold) {
      await _alertRepository.create(
        Alert(
          type: AlertType.WEIGHT_DROP,
          severity: AlertSeverity.URGENT,
          animalId: weight.animalId,
          farmId: farmId,
          message: '${percentDrop.toStringAsFixed(1)}% '
                  '(${previous.weight}kg â†’ ${weight.weight}kg)',
        ),
        farmId,
      );
    }
  }
  
  // 4. InsÃ©rer pesÃ©e
  await _dao.insert(weight);
}
```

**Condition**: `percentDrop > farmConfig.threshold` â†’ Alerte crÃ©Ã©e

---

## 4. AFFICHAGE ALERTE (4 ENDROITS)

### Ã‰cran 1: Alertes (Global)
```
ğŸš¨ ALERTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”´ URGENT (2)
  âš ï¸ Baisse de poids
  BREBIS-042: -12% (45kg â†’ 39.5kg)
```
**Condition**: Alert type = `WEIGHT_DROP`

---

### Ã‰cran 2: DetailScreen Animal
```
â”Œâ”€ BREBIS-042 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ BAISSE DE POIDS DÃ‰TECTÃ‰E  â”‚  â† Strip rouge/orange
â”‚ -12% (45kg â†’ 39.5kg)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š Poids: 39.5kg             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
**Affichage**: Strip inline si alerte active

---

### Ã‰cran 3: Liste Animaux
```
ğŸ‘ BREBIS-042        âš ï¸
   NÃ©: 15/01/2024 | 39.5kg
```
**Affichage**: IcÃ´ne âš ï¸ si animal a alerte WEIGHT_DROP active

---

### Ã‰cran 4: WeightHistoryScreen
```
23.0 kg  |  15/11/2025
22.5 kg  |  13/11/2025
âš ï¸ 20.0 kg  |  10/11/2025  â† Marker alerte
21.5 kg  |  08/11/2025
```
**Affichage**: Marker (âš ï¸) sur la pesÃ©e qui a dÃ©clenchÃ© l'alerte

---

## 5. FLUX UTILISATEUR

### ScÃ©nario: DÃ©tection baisse poids
```
1. Fermier pesÃ©e animal: 39.5kg (avant: 45kg)
   â””â”€ App envoie Ã  WeightRepository

2. Repository:
   â”œâ”€ VÃ©rifie: (45-39.5)/45 = 12%
   â”œâ”€ Seuil ferme: 10%
   â””â”€ 12% > 10% â†’ Alerte crÃ©Ã©e âœ“

3. Alerte s'affiche:
   â”œâ”€ Ã‰cran Alertes (global)
   â”œâ”€ DetailScreen animal (strip)
   â”œâ”€ Liste animaux (icÃ´ne)
   â””â”€ Historique (marker)

4. Fermier clique â†’ Voit historique + peut consulter

6. REQUÃŠTES DAO
getLatest10ByAnimal()
sqlSELECT * FROM weight_records 
WHERE animal_id = :animalId 
  AND farm_id = :farmId 
  AND deleted_at IS NULL
ORDER BY recorded_at DESC 
LIMIT 10;
Index: idx_weight_records_animal_date (farm_id, animal_id, recorded_at DESC)
getPreviousByAnimal()
sqlSELECT * FROM weight_records 
WHERE animal_id = :animalId 
  AND farm_id = :farmId 
  AND deleted_at IS NULL
ORDER BY recorded_at DESC 
LIMIT 1;

7. FICHIERS Ã€ MODIFIER
FichierTypeActionconstants.dartConstAjouter DEFAULT_WEIGHT_DROP_THRESHOLDapp_strings.dartI18N+3 clÃ©s (threshold, alert, percent)strings_fr.dartI18N+3 traductions FRweight_repository.dartRepoLogique alerte baisse poidsweight_dao.dartDAOgetLatest10ByAnimal() + getPreviousByAnimal()weight_history_screen.dartScreenCRÃ‰ERweight_history_provider.dartProviderCRÃ‰ER si besoinanimal_detail_screen.dartScreenRemplacer [+] par [ğŸ“‹ Historique]animal_list_item.dartComponentAjouter icÃ´ne âš ï¸ si alertefarm_preferences.dartModelAjouter weightDropThresholdPercentfarm_config_screen.dartScreenInput config seuil
